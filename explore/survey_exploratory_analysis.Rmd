---
title: "Analysis of PGY1 Interviews for 2018-2019"
author: "Brian Gulbis"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    code_folding: hide
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
options(knitr.table.format = "html")
```

```{r data, message=FALSE}
library(tidyverse)
library(readxl)
library(themebg)
library(kableExtra)

survey <- read_excel("../data/raw/2018_survey_responses.xlsx") %>%
    mutate_at(
        c("OriginalResponse", "ShortAnswer"), 
        na_if, 
        y = "NA"
    ) 

ratings <- read_excel("../data/raw/2018_interview_interactions.xlsx")

group <- read_excel("../data/raw/2018_responder_group.xlsx")

mh_ranking <- survey %>%
    filter(Question == 4) %>%
    mutate_at(
        "ShortAnswer", 
        factor,
        levels = c(
            "First Choice", 
            "Second Choice",
            "Third Choice or Below",
            "Did Not Rank"
        ), 
        ordered = TRUE
    ) 

rank_18_pct <- mh_ranking %>%
    count(ShortAnswer) %>%
    mutate(
        year = 2018,
        pct = n / nrow(group) * 100
    )

rank_2017 <- read_excel("../data/raw/2017_survey_responses.xlsx") %>%
    filter(Question == 5) %>%
    mutate_at(
        "ShortAnswer", 
        factor,
        levels = c(
            "First Choice", 
            "Second Choice",
            "Third Choice or Below",
            "Did Not Rank"
        ), 
        ordered = TRUE
    ) 

rank_17_pct <- rank_2017 %>%
    count(ShortAnswer) %>%
    mutate(
        year = 2017,
        pct = n / nrow(rank_2017) * 100
    )

```

## How candidates ranked our program

```{r, fig.cap="Where Respondants Ranked Us"}
rank_18_pct %>%
    bind_rows(rank_17_pct) %>%
    mutate_at("year", factor, levels = c("2018", "2017")) %>%
    ggplot(aes(x = ShortAnswer, y = pct)) +
    geom_bar(aes(fill = year), stat = "identity", position = "dodge") +
    xlab(NULL) +
    ylab("Rankings (%)") +
    scale_fill_brewer("Year", palette = "Set1") +
    theme_bg(xticks = FALSE)
```

## Reasons why we were not first choice

```{r}
x <- survey %>%
    filter(
        Question == 5, 
        !is.na(OriginalResponse)
    ) %>%
    select(-ShortAnswer) %>%
    left_join(
        mh_ranking[c("Responder", "ShortAnswer")], 
        by = "Responder"
    ) %>%
    select(
        Rating = ShortAnswer, 
        Comments = OriginalResponse
    ) %>%
    arrange(Rating) %>%
    add_count(Rating)

y <- distinct(x, Rating, n) 
    
x %>% 
    select(Comments) %>%
    knitr::kable(booktabs = TRUE) %>%
    group_rows(index = set_names(y$n, y$Rating))
```

## Ratings for each component of your interview day

```{r, fig.width=8, fig.cap="How Respondants Rated Each Portion of Interview Day"}
ratings %>%
    mutate_at(
        "Score", 
        factor, 
        levels = c(
            "Excellent", 
            "Above Average",
            "Average", 
            "Below Average"
        ), 
        ordered = TRUE
    ) %>%
    ggplot(aes(x = Score)) +
    geom_bar() +
    xlab("Rating") +
    ylab("Number of Responses") +
    facet_wrap(~ Attribute) +
    coord_flip() +
    theme_bg(yticks = FALSE)
```

## Most important factors when deciding what order to rank residency programs

```{r}
x <- survey %>%
    filter(
        Question == 2, 
        !is.na(OriginalResponse)
    ) %>%
    select(-ShortAnswer) %>%
    left_join(
        mh_ranking[c("Responder", "ShortAnswer")], 
        by = "Responder"
    ) %>%
    select(
        Rating = ShortAnswer,
        Comments = OriginalResponse
    ) %>%
    arrange(Rating) %>%
    add_count(Rating)

y <- distinct(x, Rating, n) 
    
x %>% 
    select(Comments) %>%
    knitr::kable(booktabs = TRUE) %>%
    group_rows(index = set_names(y$n, y$Rating))
```

## Did they attend the happy hour

```{r, fig.cap="Did they attend the happy hour"}
survey %>%
    filter(
        Question == 6,
        !is.na(OriginalResponse)
    ) %>%
    ggplot(aes(x = OriginalResponse)) +
    geom_bar() +
    xlab(NULL) +
    scale_y_continuous(
        "Number of Respones", 
        breaks = seq(0, 22, by = 2)
    ) +
    theme_bg(yticks = FALSE)
```

## Did the happy hour enhance the interview experience

```{r}
x <- survey %>%
    filter(
        Question == 7, 
        !is.na(OriginalResponse)
    ) %>%
    select(-ShortAnswer) %>%
    left_join(
        mh_ranking[c("Responder", "ShortAnswer")], 
        by = "Responder"
    ) %>%
    select(
        Rating = ShortAnswer,
        Comments = OriginalResponse
    ) %>%
    arrange(Rating) %>%
    add_count(Rating)

y <- distinct(x, Rating, n) 
    
x %>% 
    select(Comments) %>%
    knitr::kable(booktabs = TRUE) %>%
    group_rows(index = set_names(y$n, y$Rating))
```

## How candidates first learned of our program

```{r, fig.cap="How candidates learned of our program"}
survey %>%
    filter(Question == 1, !is.na(ShortAnswer)) %>%
    mutate_at("ShortAnswer", fct_infreq) %>%
    ggplot(aes(x = ShortAnswer)) +
    geom_bar() +
    xlab(NULL) +
    ylab("Number of Respones") +
    coord_flip() +
    theme_bg(yticks = FALSE)
```


## Provide any suggestions to improve the interview process

```{r}
x <- survey %>%
    filter(
        Question == 8, 
        !is.na(OriginalResponse)
    ) %>%
    select(-ShortAnswer) %>%
    left_join(
        mh_ranking[c("Responder", "ShortAnswer")], 
        by = "Responder"
    ) %>%
    select(
        Rating = ShortAnswer,
        Comments = OriginalResponse
    ) %>%
    arrange(Rating) %>%
    add_count(Rating)

y <- distinct(x, Rating, n) 
    
x %>% 
    select(Comments) %>%
    knitr::kable(booktabs = TRUE) %>%
    group_rows(index = set_names(y$n, y$Rating))
```
